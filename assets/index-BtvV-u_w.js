(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const m of o.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&i(m)}).observe(document,{childList:!0,subtree:!0});function s(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(l){if(l.ep)return;l.ep=!0;const o=s(l);fetch(l.href,o)}})();const E=()=>"https://api.quata.top/",d=E(),u="/api";let a={tasks:[],currentTaskId:null,subtitles:[],currentSubIndex:-1,subMode:"dual",pollingInterval:null,playbackRate:1,isLooping:!1,fontSize:24};const t={taskList:document.getElementById("taskList"),youtubeUrl:document.getElementById("youtubeUrl"),submitBtn:document.getElementById("submitBtn"),welcomeView:document.getElementById("welcomeView"),statusView:document.getElementById("statusView"),playerView:document.getElementById("playerView"),statusText:document.getElementById("statusText"),progressFill:document.getElementById("progressFill"),mainVideo:document.getElementById("mainVideo"),subtitleList:document.getElementById("subtitleList"),subModeSelect:document.getElementById("subModeSelect"),speedSlider:document.getElementById("speedSlider"),speedValue:document.getElementById("speedValue"),loopBtn:document.getElementById("loopBtn"),fullScreenBtn:document.getElementById("fullScreenBtn"),fontSizeSlider:document.getElementById("fontSizeSlider"),fontSizeValue:document.getElementById("fontSizeValue"),clearFailedBtn:document.getElementById("clearFailedBtn"),speedBtns:document.querySelectorAll(".speed-btn"),videoContainer:document.getElementById("videoContainer"),videoSubtitleOverlay:document.getElementById("videoSubtitleOverlay"),overlayEn:document.querySelector(".overlay-en"),overlayCn:document.querySelector(".overlay-cn"),customModal:document.getElementById("customModal"),modalTitle:document.getElementById("modalTitle"),modalMessage:document.getElementById("modalMessage"),modalConfirmBtn:document.getElementById("modalConfirmBtn"),modalCancelBtn:document.getElementById("modalCancelBtn")};function I(){t.submitBtn.addEventListener("click",S),t.subModeSelect.addEventListener("change",n=>{if(a.subMode=n.target.value,h(),a.currentSubIndex!==-1){const s=a.subtitles[a.currentSubIndex];t.overlayEn.innerText=a.subMode!=="cn"?s.en:"",t.overlayCn.innerText=a.subMode!=="en"?s.cn:"",a.subMode==="none"&&(t.overlayEn.innerText="",t.overlayCn.innerText="")}}),t.mainVideo.addEventListener("timeupdate",()=>{$(t.mainVideo.currentTime)}),t.speedBtns.forEach(n=>{n.addEventListener("click",()=>{const s=parseFloat(n.dataset.speed);v(s)})}),t.speedSlider.addEventListener("input",n=>{const s=parseFloat(n.target.value);v(s,!1)}),t.loopBtn.addEventListener("click",L),t.fullScreenBtn.addEventListener("click",B),t.fontSizeSlider.addEventListener("input",n=>{const s=n.target.value;p(s)}),t.clearFailedBtn.addEventListener("click",k);const e=()=>{document.fullscreenElement!==null?t.videoSubtitleOverlay.classList.remove("hidden"):t.videoSubtitleOverlay.classList.add("hidden")};document.addEventListener("fullscreenchange",e),document.addEventListener("webkitfullscreenchange",e),p(a.fontSize),c(),setInterval(c,1e4)}function v(e,n=!0){a.playbackRate=e,t.mainVideo.playbackRate=e,t.speedValue.innerText=e.toFixed(1)+"x",n&&(t.speedSlider.value=e),t.speedBtns.forEach(s=>{parseFloat(s.dataset.speed)===e?s.classList.add("active"):s.classList.remove("active")})}function L(){a.isLooping=!a.isLooping,t.loopBtn.classList.toggle("active",a.isLooping)}function B(){document.fullscreenElement?document.exitFullscreen():t.videoContainer.requestFullscreen().catch(e=>{console.error(`无法进入全屏: ${e.message}`)})}function p(e){a.fontSize=e,t.fontSizeValue.innerText=e+"px",t.videoContainer.style.setProperty("--sub-font-size",e+"px")}async function c(){try{const e=await fetch(`${d}${u}/tasks`);if(!e.ok)throw new Error("Failed to fetch tasks");let n=await e.json();n.sort((s,i)=>(i.createdAt||0)-(s.createdAt||0)),a.tasks=n,g()}catch(e){console.warn("Task list loading failed:",e)}}function g(){if(t.taskList){if(a.tasks.length===0){t.taskList.innerHTML='<div class="no-tasks">暂无任务</div>';return}t.taskList.innerHTML=a.tasks.map(e=>{const n=e.status==="completed",s=a.currentTaskId===e.taskId,i=e.title||e.url;return`
            <div class="task-item status-${e.status} ${s?"active":""}" 
                 data-task-id="${e.taskId}"
                 title="链接: ${e.url}
状态: ${f(e.status)}
进度: ${e.progress||0}%"
                 style="cursor: ${n?"pointer":"default"}">
                <button class="delete-task" data-task-id="${e.taskId}" title="删除任务">✕</button>
                <div class="task-title" title="${i}">${i}</div>
                <div class="task-status">
                    <span class="status-dot dot-${e.status}"></span>
                    ${f(e.status)} ${e.progress?`(${e.progress}%)`:""}
                </div>
            </div>
        `}).join(""),t.taskList.querySelectorAll(".task-item").forEach(e=>{e.addEventListener("click",n=>{if(n.target.classList.contains("delete-task"))return;const s=e.dataset.taskId,i=a.tasks.find(l=>l.taskId===s);i&&i.status==="completed"&&b(s)})}),t.taskList.querySelectorAll(".delete-task").forEach(e=>{e.addEventListener("click",async n=>{n.stopPropagation();const s=e.dataset.taskId;await r("确认删除","确定要彻底删除这个学习任务吗？删除后将无法找回。")&&T(s)})})}}function r(e,n,s={showCancel:!0,confirmText:"确定",cancelText:"取消"}){return new Promise(i=>{t.modalTitle.innerText=e,t.modalMessage.innerText=n,t.modalConfirmBtn.innerText=s.confirmText||"确定",t.modalCancelBtn.innerText=s.cancelText||"取消",s.showCancel===!1?t.modalCancelBtn.classList.add("hidden"):t.modalCancelBtn.classList.remove("hidden");const l=()=>{m(),i(!0)},o=()=>{m(),i(!1)},m=()=>{t.modalConfirmBtn.removeEventListener("click",l),t.modalCancelBtn.removeEventListener("click",o),t.customModal.classList.add("hidden")};t.modalConfirmBtn.addEventListener("click",l),t.modalCancelBtn.addEventListener("click",o),t.customModal.classList.remove("hidden")})}async function T(e){try{(await fetch(`${d}${u}/tasks/${e}`,{method:"DELETE"})).ok?(a.currentTaskId===e&&(a.currentTaskId=null,y("welcome")),c()):r("删除失败","服务器返回错误，请稍后再试。",{showCancel:!1})}catch(n){console.error("Delete task error",n),r("删除失败","无法连接到服务器: "+n.message,{showCancel:!1})}}async function k(){if(await r("清理异常任务","系统将清理所有状态为“失败”的任务。确定要继续吗？"))try{(await fetch(`${d}${u}/tasks/failed`,{method:"DELETE"})).ok?c():r("清理失败","清理过程中出现服务器错误。",{showCancel:!1})}catch(n){console.error("Clear failed tasks error",n),r("清理失败","无法连接到服务器: "+n.message,{showCancel:!1})}}function f(e){return{completed:"已完成",processing:"处理中",failed:"失败",pending:"等待中"}[e]||e}async function b(e){a.currentTaskId=e,g(),y("player");try{const s=await(await fetch(`${d}${u}/status/${e}`)).json();s.videoId&&x(s.videoId)}catch(n){console.error("Failed to load task details",n)}}async function S(){const e=t.youtubeUrl.value.trim();if(!e){r("提示","请输入有效的 YouTube 视频链接。",{showCancel:!1});return}t.submitBtn.disabled=!0;const n=t.submitBtn.innerText;t.submitBtn.innerText="提交中...";try{const i=await(await fetch(`${d}${u}/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})})).json();if(i.taskId)y("status"),w(i.taskId),c();else throw new Error("任务提交失败")}catch(s){r("提交失败","提交过程中出现错误: "+s.message,{showCancel:!1})}finally{t.submitBtn.disabled=!1,t.submitBtn.innerText=n}}function w(e){a.pollingInterval&&clearInterval(a.pollingInterval),a.pollingInterval=setInterval(async()=>{try{const s=await(await fetch(`${d}${u}/status/${e}`)).json();t.progressFill.style.width=s.progress+"%",t.statusText.innerText=`${f(s.status)}... (${s.progress}%)`,s.status==="completed"?(clearInterval(a.pollingInterval),c(),b(e)):s.status==="failed"&&(clearInterval(a.pollingInterval),t.statusText.innerText="处理失败: "+(s.error||"未知错误"),t.submitBtn.disabled=!1,c())}catch(n){console.error("Polling error",n)}},2e3)}async function x(e){try{const s=await(await fetch(`${d}${u}/course/${e}/detail`)).json();let i=s.videoUrl;i.startsWith("/")&&(i=`${d}${i}`),t.mainVideo.src=i,t.mainVideo.playbackRate=a.playbackRate,a.subtitles=s.subtitles||[],a.currentSubIndex=-1,h()}catch(n){console.error(n),r("加载失败","无法加载视频内容，请检查网络或稍后重试。",{showCancel:!1})}}function h(){t.subtitleList.className=`subtitle-list mode-${a.subMode}`,t.subtitleList.innerHTML=a.subtitles.map((e,n)=>`
        <div class="sub-item" id="sub-${n}" data-start="${e.startTime}">
            <div class="en-text">${e.en||""}</div>
            <div class="cn-text">${e.cn||""}</div>
        </div>
    `).join(""),document.querySelectorAll(".sub-item").forEach(e=>{e.addEventListener("click",()=>{t.mainVideo.currentTime=parseFloat(e.dataset.start),t.mainVideo.play()})})}function $(e){if(a.isLooping&&a.currentSubIndex!==-1){const s=a.subtitles[a.currentSubIndex];if(e>=s.endTime-.1){t.mainVideo.currentTime=s.startTime;return}}const n=a.subtitles.findIndex(s=>e>=s.startTime&&e<s.endTime);if(n!==-1&&n!==a.currentSubIndex){const s=document.getElementById(`sub-${a.currentSubIndex}`);s&&s.classList.remove("active");const i=document.getElementById(`sub-${n}`);i&&(i.classList.add("active"),i.scrollIntoView({behavior:"smooth",block:"center"})),a.currentSubIndex=n;const l=a.subtitles[n];l&&(t.overlayEn.innerText=a.subMode!=="cn"?l.en:"",t.overlayCn.innerText=a.subMode!=="en"?l.cn:"",a.subMode==="none"&&(t.overlayEn.innerText="",t.overlayCn.innerText=""))}else n===-1&&a.currentSubIndex!==-1&&(t.overlayEn.innerText="",t.overlayCn.innerText="",a.currentSubIndex=-1)}function y(e){t.welcomeView.classList.add("hidden"),t.statusView.classList.add("hidden"),t.playerView.classList.add("hidden"),e==="welcome"&&t.welcomeView.classList.remove("hidden"),e==="status"&&t.statusView.classList.remove("hidden"),e==="player"&&t.playerView.classList.remove("hidden")}document.addEventListener("DOMContentLoaded",I);
